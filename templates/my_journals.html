{% extends 'base.html' %}
{% load time_filters %}
{% load static %}

{% block title %}My Journals - Digital Journal App{% endblock %}

{% block content %}
{% csrf_token %}
<link rel="stylesheet" href="{% static 'css/emotion_styles.css' %}">
<link rel="stylesheet" href="{% static 'css/visibility_styles.css' %}">
<style>
.upcoming-reminders-section {
    margin: 2rem 0;
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.reminders-title {
    margin: 0 0 1rem 0;
    font-size: 1.5rem;
    color: #333;
}

.reminders-list {
    display: grid;
    gap: 1rem;
}

.reminder-card {
    background: white;
    padding: 1rem;
    border-radius: 6px;
    border-left: 4px solid #007bff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.reminder-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.reminder-type {
    font-weight: 600;
    color: #007bff;
    font-size: 0.9rem;
}

.reminder-date {
    color: #666;
    font-size: 0.9rem;
}

.reminder-entry a {
    color: #333;
    text-decoration: none;
    font-weight: 500;
}

.reminder-entry a:hover {
    color: #007bff;
    text-decoration: underline;
}

.loading-message, .no-reminders, .error-message {
    text-align: center;
    padding: 2rem;
    color: #666;
    font-style: italic;
}

.error-message {
    color: #dc3545;
}
</style>
<div class="my-journals-container">
    <div class="my-journals-header">
        <a href="{% url 'home' %}" class="back-button">
            <span>‚Üê Back</span>
        </a>
        <h1 class="my-journals-title">My Journals</h1>
    </div>
    
    <!-- Filter Controls -->
    <div class="journals-filters">
        <div class="filter-group">
            <label class="filter-label">Show:</label>
            <div class="filter-buttons">
                <a href="?visibility=all{% if search_query %}&search={{ search_query }}{% endif %}" 
                   class="filter-btn {% if visibility_filter == 'all' or not visibility_filter %}active{% endif %}">
                    All Entries
                </a>
                <a href="?visibility=private{% if search_query %}&search={{ search_query }}{% endif %}" 
                   class="filter-btn {% if visibility_filter == 'private' %}active{% endif %}">
                    üîí Private Only
                </a>
                <a href="?visibility=shared{% if search_query %}&search={{ search_query }}{% endif %}" 
                   class="filter-btn {% if visibility_filter == 'shared' %}active{% endif %}">
                    üåê Shared Only
                </a>
            </div>
        </div>
        
        <div class="filter-group">
            <label class="filter-label">Tags:</label>
            <div class="filter-buttons">
                <a href="?visibility={{ visibility_filter }}{% if search_query %}&search={{ search_query }}{% endif %}"
                   class="filter-btn {% if not selected_tag %}active{% endif %}">
                    All Tags
                </a>
                {% for tag in tags %}
                    <a href="?visibility={{ visibility_filter }}{% if search_query %}&search={{ search_query }}{% endif %}&tag={{ tag.slug }}"
                       class="filter-btn {% if selected_tag == tag.slug %}active{% endif %}">
                        {{ tag.name }} ({{ tag.entry_count }})
                    </a>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Upcoming Reminders Section -->
    <div class="upcoming-reminders-section">
        <h2 class="reminders-title">‚è∞ Upcoming Reminders</h2>
        <div id="reminders-list" class="reminders-list">
            <div class="loading-message">Loading reminders...</div>
        </div>
    </div>
    
    <!-- Bookmarked Entries Section -->
    {% if bookmarked_entries %}
        <div class="bookmarked-section">
            <h2 class="bookmarked-title">üìå Bookmarked Entries</h2>
            <div class="bookmarked-grid">
                {% for entry in bookmarked_entries %}
                    <div class="journal-card bookmarked-card" data-entry-id="{{ entry.id }}" onclick="openJournalModal({{ entry.id }})">
                        <div class="journal-card-header">
                            <div class="journal-date">{{ entry.created_at|date:"M d, Y" }}</div>
                            <div class="journal-badges">
                                <span class="visibility-badge visibility-{{ entry.visibility }}" 
                                      title="{{ entry.get_visibility_display }}">
                                    {% if entry.visibility == 'private' %}
                                        üîí Private
                                    {% else %}
                                        üåê Shared
                                    {% endif %}
                                </span>
                                <button class="bookmark-btn bookmarked" onclick="toggleBookmark({{ entry.id }}, event)" title="Remove bookmark">
                                    üìå
                                </button>
                            </div>
                        </div>
                        <div class="journal-card-content">
                            <div class="journal-detail">
                                <span class="detail-label">Title:</span>
                                <span class="detail-value">{{ entry.title }}</span>
                                <span class="emotion-badge emotion-{{ entry.primary_emotion }}">
                                    {{ entry.get_primary_emotion_display }}
                                </span>
                                <span class="sentiment-score" title="Sentiment Score: {{ entry.sentiment_score }}">
                                    {{ entry.sentiment_score|floatformat:2 }}
                                </span>
                            </div>
                            <div class="journal-detail">
                                <span class="detail-label">Theme:</span>
                                <span class="detail-value">{{ entry.theme.name }}</span>
                            </div>
                            <div class="journal-detail">
                                <span class="detail-label">Writing Time:</span>
                                <span class="detail-value writing-time">
                                    {{ entry.writing_time|format_writing_time }}
                                </span>
                            </div>
                            <div class="journal-detail">
                                <span class="detail-label">Prompt:</span>
                                <span class="detail-value prompt-text">{{ entry.prompt|truncatewords:20 }}</span>
                            </div>
                            <div class="journal-detail">
                                <span class="detail-label">Answer:</span>
                                <span class="detail-value answer-text">{{ entry.answer|truncatewords:30 }}</span>
                            </div>
                            <div class="journal-detail">
                                <span class="detail-label">Tags:</span>
                                <span class="detail-value">
                                    {% for tag in entry.tags.all %}
                                        <span class="tag-chip">{{ tag.name }}</span>
                                    {% empty %}
                                        <span class="tag-chip muted">None</span>
                                    {% endfor %}
                                </span>
                            </div>
                            <div class="expand-hint">
                                <span>Click to expand</span>
                            </div>
                        </div>
                        <button class="delete-journal-btn" onclick="deleteJournalEntry({{ entry.id }}, event)" title="Delete journal entry">
                            ‚úï
                        </button>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
    
    <!-- Regular Entries Section -->
    {% if regular_entries %}
        <div class="other-entries-section">
            <h2 class="other-entries-title">üìù Other Entries</h2>
            <div class="journals-grid">
                {% for entry in regular_entries %}
                    <div class="journal-card" data-entry-id="{{ entry.id }}" onclick="openJournalModal({{ entry.id }})">
                        <div class="journal-card-header">
                            <div class="journal-date">{{ entry.created_at|date:"M d, Y" }}</div>
                            <div class="journal-badges">
                                <span class="visibility-badge visibility-{{ entry.visibility }}" 
                                      title="{{ entry.get_visibility_display }}">
                                    {% if entry.visibility == 'private' %}
                                        üîí Private
                                    {% else %}
                                        üåê Shared
                                    {% endif %}
                                </span>
                                <button class="bookmark-btn" onclick="toggleBookmark({{ entry.id }}, event)" title="Add bookmark">
                                    üìå
                                </button>
                            </div>
                        </div>
                        <div class="journal-card-content">
                            <div class="journal-detail">
                                <span class="detail-label">Title:</span>
                                <span class="detail-value">{{ entry.title }}</span>
                                <span class="emotion-badge emotion-{{ entry.primary_emotion }}">
                                    {{ entry.get_primary_emotion_display }}
                                </span>
                                <span class="sentiment-score" title="Sentiment Score: {{ entry.sentiment_score }}">
                                    {{ entry.sentiment_score|floatformat:2 }}
                                </span>
                            </div>
                            <div class="journal-detail">
                                <span class="detail-label">Theme:</span>
                                <span class="detail-value">{{ entry.theme.name }}</span>
                            </div>
                            <div class="journal-detail">
                                <span class="detail-label">Writing Time:</span>
                                <span class="detail-value writing-time">
                                    {{ entry.writing_time|format_writing_time }}
                                </span>
                            </div>
                            <div class="journal-detail">
                                <span class="detail-label">Prompt:</span>
                                <span class="detail-value prompt-text">{{ entry.prompt|truncatewords:20 }}</span>
                            </div>
                            <div class="journal-detail">
                                <span class="detail-label">Answer:</span>
                                <span class="detail-value answer-text">{{ entry.answer|truncatewords:30 }}</span>
                            </div>
                            <div class="journal-detail">
                                <span class="detail-label">Tags:</span>
                                <span class="detail-value">
                                    {% for tag in entry.tags.all %}
                                        <span class="tag-chip">{{ tag.name }}</span>
                                    {% empty %}
                                        <span class="tag-chip muted">None</span>
                                    {% endfor %}
                                </span>
                            </div>
                            <div class="expand-hint">
                                <span>Click to expand</span>
                            </div>
                        </div>
                        <button class="delete-journal-btn" onclick="deleteJournalEntry({{ entry.id }}, event)" title="Delete journal entry">
                            ‚úï
                        </button>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
    
    <!-- No entries message -->
    {% if not bookmarked_entries and not regular_entries %}
        <div class="no-journals">
            <div class="no-journals-content">
                <h3>No journal entries yet</h3>
                <p>Start your journaling journey by creating your first entry.</p>
                <a href="{% url 'theme_selector' %}" class="create-first-btn">
                    Create Your First Journal
                </a>
            </div>
        </div>
    {% endif %}
    
    {% if bookmarked_entries or regular_entries %}
    <div class="journals-stats">
        <p class="stats-text">
            Showing 
            {% if bookmarked_entries %}{{ bookmarked_entries.count }} bookmarked entr{{ bookmarked_entries.count|pluralize:"y,ies" }}{% endif %}
            {% if bookmarked_entries and regular_entries %} and {% endif %}
            {% if regular_entries %}{{ regular_entries.count }} other entr{{ regular_entries.count|pluralize:"y,ies" }}{% endif %}
        </p>
    </div>
    {% endif %}
</div>

<!-- Journal Modal -->
<div id="journalModal" class="journal-modal">
    <div class="journal-modal-content">
        <div class="journal-modal-header">
            <h2 class="modal-title">Journal Entry</h2>
            <button class="modal-close" onclick="closeJournalModal()">&times;</button>
        </div>
        <div class="journal-modal-body">
            <div class="modal-journal-card">
                <div class="modal-journal-header">
                    <div class="modal-journal-date" id="modalDate"></div>
                </div>
                <div class="modal-journal-content">
                    <div class="modal-journal-detail">
                        <span class="modal-detail-label">Title:</span>
                        <span class="modal-detail-value" id="modalTitle"></span>
                        <span class="emotion-badge emotion-neutral" id="modalEmotion">
                            Neutral
                        </span>
                        <span class="sentiment-score" id="modalSentiment">0.00</span>
                    </div>
                    <div class="modal-journal-detail">
                        <span class="modal-detail-label">Theme:</span>
                        <span class="modal-detail-value" id="modalTheme"></span>
                    </div>
                    <div class="modal-journal-detail">
                        <span class="modal-detail-label">Writing Time:</span>
                        <span class="modal-detail-value writing-time" id="modalWritingTime"></span>
                    </div>
                    <div class="modal-journal-detail">
                        <span class="modal-detail-label">Prompt:</span>
                        <span class="modal-detail-value modal-prompt-text" id="modalPrompt"></span>
                    </div>
                    <div class="modal-journal-detail">
                        <span class="modal-detail-label">Answer:</span>
                        <span class="modal-detail-value modal-answer-text" id="modalAnswer"></span>
                    </div>
                    <div class="modal-actions">
                        <button class="visibility-toggle-btn" 
                                onclick="toggleVisibility()"
                                id="visibilityToggleBtn">
                            <span class="visibility-icon" id="visibilityIcon">üîí</span>
                            <span class="visibility-toggle-text" id="visibilityToggleText">
                                Make Shared
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.querySelector('.navbar-search-input');
    
    // Auto-submit search form as user types
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            this.form.submit();
        }, 500);
    });
    
    // Load upcoming reminders
    loadUpcomingReminders();
});

function loadUpcomingReminders() {
    const remindersList = document.getElementById('reminders-list');
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('/home/api/reminders/upcoming/', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.reminders && data.reminders.length > 0) {
            renderReminders(data.reminders.slice(0, 10)); // Show next 10
        } else {
            remindersList.innerHTML = '<div class="no-reminders">No upcoming reminders</div>';
        }
    })
    .catch(error => {
        console.error('Error loading reminders:', error);
        remindersList.innerHTML = '<div class="error-message">Failed to load reminders</div>';
    });
}

function renderReminders(reminders) {
    const remindersList = document.getElementById('reminders-list');
    let html = '';
    
    reminders.forEach(reminder => {
        const nextRun = new Date(reminder.next_run_at);
        const formattedDate = nextRun.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        });
        
        const typeLabel = reminder.type === 'one_time' ? 'üîî One-time' : 'üîÅ Recurring';
        const frequencyLabel = reminder.frequency ? ` (${reminder.frequency})` : '';
        
        html += `
            <div class="reminder-card">
                <div class="reminder-header">
                    <span class="reminder-type">${typeLabel}${frequencyLabel}</span>
                    <span class="reminder-date">${formattedDate}</span>
                </div>
                <div class="reminder-entry">
                    <a href="#" onclick="openJournalModal(${reminder.journal_entry_id}); return false;">
                        ${reminder.entry_title || 'View Entry'}
                    </a>
                </div>
            </div>
        `;
    });
    
    remindersList.innerHTML = html;
}

// Journal entry data
const journalEntries = {};
{% for entry in bookmarked_entries %}
journalEntries[{{ entry.id }}] = {
    date: "{{ entry.created_at|date:'M d, Y' }}",
    title: "{{ entry.title|escapejs }}",
    theme: "{{ entry.theme.name|escapejs }}",
    prompt: "{{ entry.prompt|escapejs }}",
    answer: "{{ entry.answer|escapejs }}",
    bookmarked: true,
    writing_time: {{ entry.writing_time|default:0 }},
    primary_emotion: "{{ entry.primary_emotion }}",
    sentiment_score: {{ entry.sentiment_score }},
    visibility: "{{ entry.visibility }}"
};
{% endfor %}
{% for entry in regular_entries %}
journalEntries[{{ entry.id }}] = {
    date: "{{ entry.created_at|date:'M d, Y' }}",
    title: "{{ entry.title|escapejs }}",
    theme: "{{ entry.theme.name|escapejs }}",
    prompt: "{{ entry.prompt|escapejs }}",
    answer: "{{ entry.answer|escapejs }}",
    bookmarked: false,
    writing_time: {{ entry.writing_time|default:0 }},
    primary_emotion: "{{ entry.primary_emotion }}",
    sentiment_score: {{ entry.sentiment_score }},
    visibility: "{{ entry.visibility }}"
};
{% endfor %}

// Helper function to format writing time
function formatWritingTime(seconds) {
    if (!seconds || seconds === 0) {
        return 'N/A';
    }
    
    if (seconds >= 3600) {
        const hours = (seconds / 3600).toFixed(1);
        return `${hours}h`;
    } else if (seconds >= 60) {
        const minutes = Math.floor(seconds / 60);
        return `${minutes}m`;
    } else {
        return `${seconds}s`;
    }
}

function openJournalModal(entryId) {
    const entry = journalEntries[entryId];
    if (!entry) return;
    
    // Store current entry ID for visibility toggle
    window.currentModalEntryId = entryId;
    
    // Populate modal content
    document.getElementById('modalDate').textContent = entry.date;
    document.getElementById('modalTitle').textContent = entry.title;
    document.getElementById('modalTheme').textContent = entry.theme;
    document.getElementById('modalPrompt').textContent = entry.prompt;
    document.getElementById('modalAnswer').textContent = entry.answer;
    document.getElementById('modalWritingTime').textContent = formatWritingTime(entry.writing_time);
    
    // Populate emotion data
    const emotionBadge = document.getElementById('modalEmotion');
    emotionBadge.textContent = entry.primary_emotion || 'Neutral';
    emotionBadge.className = 'emotion-badge emotion-' + (entry.primary_emotion || 'neutral');
    document.getElementById('modalSentiment').textContent = (entry.sentiment_score || 0).toFixed(2);
    
    // Update visibility toggle button
    updateVisibilityToggleButton(entry.visibility);
    
    // Show modal
    document.getElementById('journalModal').style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
}

function updateVisibilityToggleButton(visibility) {
    const icon = document.getElementById('visibilityIcon');
    const text = document.getElementById('visibilityToggleText');
    
    if (visibility === 'private') {
        icon.textContent = 'üîí';
        text.textContent = 'Make Shared';
    } else {
        icon.textContent = 'üåê';
        text.textContent = 'Make Private';
    }
}

function toggleVisibility() {
    const entryId = window.currentModalEntryId;
    if (!entryId) return;
    
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/home/toggle-visibility/${entryId}/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Refresh the page to show updated visibility
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error toggling visibility:', error);
        alert('Failed to change visibility. Please try again.');
    });
}

function closeJournalModal() {
    document.getElementById('journalModal').style.display = 'none';
    document.body.style.overflow = 'auto'; // Restore scrolling
}

// Close modal when clicking outside
document.getElementById('journalModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeJournalModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeJournalModal();
    }
});

function toggleBookmark(entryId, event) {
    // Prevent the card click event from triggering
    event.stopPropagation();
    
    // Create a form to submit the bookmark toggle request
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/home/toggle-bookmark/${entryId}/`;
    
    // Add CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrfToken;
    form.appendChild(csrfInput);
    
    // Submit the form
    document.body.appendChild(form);
    form.submit();
}

function deleteJournalEntry(entryId, event) {
    // Prevent the card click event from triggering
    event.stopPropagation();
    
    // Show confirmation dialog
    if (confirm('Are you sure you want to delete this journal entry? This action cannot be undone.')) {
        // Create a form to submit the delete request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/home/delete-journal/${entryId}/`;
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        // Submit the form
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %} 