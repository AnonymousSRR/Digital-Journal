{% extends 'base.html' %}

{% block title %}Home - Digital Journal App{% endblock %}

{% block content %}
<div class="home-container">
    <div class="welcome-message">
        <h2>Hi {{ user.first_name }}, what's your plan today?</h2>
    </div>
    
    <!-- Summary Widget -->
    <div class="summary-widget" data-testid="summary-widget">
        <div class="summary-card" data-testid="total-entries-card">
            <div class="summary-icon">üìù</div>
            <div class="summary-content">
                <div class="summary-value" data-testid="total-entries-value">{{ total_entries }}</div>
                <div class="summary-label">Total Entries</div>
            </div>
        </div>
        
        <div class="summary-card" data-testid="entries-week-card">
            <div class="summary-icon">üìÖ</div>
            <div class="summary-content">
                <div class="summary-value" data-testid="entries-week-value">{{ entries_this_week }}</div>
                <div class="summary-label">Entries This Week</div>
            </div>
        </div>
        
        <div class="summary-card" data-testid="emotion-card">
            <div class="summary-icon">üòä</div>
            <div class="summary-content">
                <div class="summary-value" data-testid="emotion-value">{{ most_common_emotion }}</div>
                <div class="summary-label">Most Common Emotion</div>
            </div>
        </div>
        
        <div class="summary-card streak-card" data-testid="streak-card">
            <div class="summary-icon">üî•</div>
            <div class="summary-content">
                <div class="summary-value" data-testid="streak-value">{{ current_streak }}</div>
                <div class="summary-label">Day Streak</div>
            </div>
        </div>
    </div>
    
    <!-- Existing dashboard buttons -->
    <div class="dashboard-buttons">
        <a href="{% url 'theme_selector' %}" class="dashboard-button" id="create-journal-btn" data-testid="create-journal-btn">
            <span class="button-text">Create New Journal</span>
        </a>
        <a href="{% url 'my_journals' %}" class="dashboard-button" id="my-journals-btn" data-testid="my-journals-btn">
            <span class="button-text">My Journals</span>
        </a>
    </div>
</div>

<!-- Quick Add Floating Action Button -->
{% if show_quick_add_fab %}
<button 
    id="quick-add-btn" 
    class="fab" 
    aria-label="Quick add journal entry"
    title="Quick add journal entry"
    data-testid="quick-add-btn"
    type="button"
>
    <span class="fab-icon" aria-hidden="true">+</span>
</button>

<!-- Quick Add Modal -->
<div id="quickAddModal" class="quick-modal" hidden>
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <h3>Quick Add Journal Entry</h3>
        <form id="quickAddForm">
            {% csrf_token %}
            <div class="form-group">
                <input 
                    type="text" 
                    id="quick-title" 
                    name="title" 
                    placeholder="Entry Title" 
                    required
                    data-testid="quick-add-title"
                >
            </div>
            <div class="form-group">
                <textarea 
                    id="quick-body" 
                    name="body" 
                    placeholder="Write something..." 
                    rows="6" 
                    required
                    data-testid="quick-add-body"
                ></textarea>
            </div>
            <div class="error-message" id="quick-error" hidden></div>
            <div class="modal-actions">
                <button type="submit" class="btn-primary" data-testid="quick-add-submit">
                    <span class="btn-text">Save</span>
                    <span class="btn-loading" hidden>Saving...</span>
                </button>
                <button type="button" id="quickAddCancel" class="btn-secondary" data-testid="quick-add-cancel">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const createJournalBtn = document.getElementById('create-journal-btn');
    {% if show_quick_add_fab %}
    const quickAddBtn = document.getElementById('quick-add-btn');
    const quickAddModal = document.getElementById('quickAddModal');
    const quickAddForm = document.getElementById('quickAddForm');
    const quickAddCancel = document.getElementById('quickAddCancel');
    const errorDiv = document.getElementById('quick-error');
    
    // CRITICAL: Verify modal starts hidden
    if (!quickAddModal.hasAttribute('hidden')) {
        console.error('Quick-add modal should be hidden by default');
        quickAddModal.setAttribute('hidden', '');
    }
    
    // Remove any existing auto-open logic from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('quick-add') && urlParams.get('quick-add') === 'open') {
        // Remove this behavior - modal should only open via FAB click
        console.warn('Removed auto-open behavior from URL parameter');
        // Remove the parameter from URL without reloading
        urlParams.delete('quick-add');
        const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
        window.history.replaceState({}, '', newUrl);
    }
    
    // Start timer for regular journal creation
    createJournalBtn.addEventListener('click', function() {
        const startTime = Date.now();
        sessionStorage.setItem('journalWritingStartTime', startTime.toString());
        console.log('Timer started at:', new Date(startTime));
    });
    
    // Analytics tracking
    let modalOpenTime = null;
    
    // Track FAB clicks
    quickAddBtn.addEventListener('click', function(e) {
        e.preventDefault();
        modalOpenTime = Date.now();
        
        // Send analytics event
        fetch('/home/api/analytics/track/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                event: 'quick_add_fab_clicked',
                timestamp: modalOpenTime,
                page: 'home'
            })
        }).catch(err => console.warn('Analytics failed:', err));
        
        quickAddModal.removeAttribute('hidden');
        document.getElementById('quick-title').focus();
    });
    
    // Track modal closes
    function trackModalClose(closeReason) {
        if (modalOpenTime) {
            const duration = Date.now() - modalOpenTime;
            fetch('/home/api/analytics/track/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    event: 'quick_add_modal_closed',
                    duration: duration,
                    close_reason: closeReason,
                    timestamp: Date.now()
                })
            }).catch(err => console.warn('Analytics failed:', err));
            
            modalOpenTime = null;
        }
    }
    
    // Close quick add modal
    function closeModal() {
        quickAddModal.setAttribute('hidden', '');
        quickAddForm.reset();
        errorDiv.setAttribute('hidden', '');
        errorDiv.textContent = '';
    }
    
    quickAddCancel.addEventListener('click', function() {
        trackModalClose('cancel_button');
        closeModal();
    });
    
    // Close on overlay click
    quickAddModal.querySelector('.modal-overlay').addEventListener('click', function() {
        trackModalClose('overlay_click');
        closeModal();
    });
    
    // Handle form submission
    quickAddForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const title = document.getElementById('quick-title').value.trim();
        const body = document.getElementById('quick-body').value.trim();
        const submitBtn = quickAddForm.querySelector('[type="submit"]');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnLoading = submitBtn.querySelector('.btn-loading');
        
        // Clear previous errors
        errorDiv.setAttribute('hidden', '');
        errorDiv.textContent = '';
        
        // Disable button and show loading
        submitBtn.disabled = true;
        btnText.setAttribute('hidden', '');
        btnLoading.removeAttribute('hidden');
        
        try {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const response = await fetch('/home/api/journals/quick-add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ title, body })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                // Track successful submission
                trackModalClose('form_submit');
                
                // Redirect to My Journals with highlight
                window.location.href = `/home/my-journals/?highlight=${data.entry.id}`;
            } else {
                // Show error
                const errorMsg = data.errors?.title || 'Failed to create entry. Please try again.';
                errorDiv.textContent = errorMsg;
                errorDiv.removeAttribute('hidden');
                
                // Re-enable button
                submitBtn.disabled = false;
                btnText.removeAttribute('hidden');
                btnLoading.setAttribute('hidden', '');
            }
        } catch (error) {
            console.error('Error creating quick entry:', error);
            errorDiv.textContent = 'Network error. Please check your connection and try again.';
            errorDiv.removeAttribute('hidden');
            
            // Re-enable button
            submitBtn.disabled = false;
            btnText.removeAttribute('hidden');
            btnLoading.setAttribute('hidden', '');
        }
    });
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !quickAddModal.hasAttribute('hidden')) {
            closeModal();
        }
    });
    {% endif %}
});
</script>
{% endblock %}