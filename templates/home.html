{% extends 'base.html' %}

{% block title %}Home - Digital Journal App{% endblock %}

{% block content %}
<div class="home-container">
    <div class="welcome-message">
        <h2>Hi {{ user.first_name }}, what's your plan today?</h2>
        {% if not show_quick_add_fab %}
        <p class="feature-notice">
            üí° Want quick access to create journal entries? 
            <a href="#" id="enable-quick-add" class="enable-link">Enable Quick Add button</a>
        </p>
        {% endif %}
    </div>
    
    <!-- Summary Widget -->
    <div class="summary-widget" data-testid="summary-widget">
        <div class="summary-card" data-testid="total-entries-card">
            <div class="summary-icon">üìù</div>
            <div class="summary-content">
                <div class="summary-value" data-testid="total-entries-value">{{ total_entries }}</div>
                <div class="summary-label">Total Entries</div>
            </div>
        </div>
        
        <div class="summary-card" data-testid="entries-week-card">
            <div class="summary-icon">üìÖ</div>
            <div class="summary-content">
                <div class="summary-value" data-testid="entries-week-value">{{ entries_this_week }}</div>
                <div class="summary-label">Entries This Week</div>
            </div>
        </div>
        
        <div class="summary-card" data-testid="emotion-card">
            <div class="summary-icon">üòä</div>
            <div class="summary-content">
                <div class="summary-value" data-testid="emotion-value">{{ most_common_emotion }}</div>
                <div class="summary-label">Most Common Emotion</div>
            </div>
        </div>
        
        <div class="summary-card streak-card" data-testid="streak-card">
            <div class="summary-icon">üî•</div>
            <div class="summary-content">
                <div class="summary-value" data-testid="streak-value">{{ current_streak }}</div>
                <div class="summary-label">Day Streak</div>
            </div>
        </div>
    </div>
    
    <!-- Existing dashboard buttons -->
    <div class="dashboard-buttons">
        <a href="{% url 'theme_selector' %}" class="dashboard-button" id="create-journal-btn" data-testid="create-journal-btn">
            <span class="button-text">Create New Journal</span>
        </a>
        <a href="{% url 'my_journals' %}" class="dashboard-button" id="my-journals-btn" data-testid="my-journals-btn">
            <span class="button-text">My Journals</span>
        </a>
    </div>
</div>

<!-- Quick Add Floating Action Button -->
{% if show_quick_add_fab %}
<button 
    id="quick-add-btn" 
    class="fab" 
    aria-label="Quick add journal entry"
    title="Quick add journal entry"
    data-testid="quick-add-btn"
    type="button"
>
    <span class="fab-icon" aria-hidden="true">+</span>
</button>

<!-- Quick Add Modal -->
<div id="quickAddModal" class="quick-modal" hidden>
    <div class="modal-overlay"></div>
    <div class="modal-content">
        <h3>Quick Add Journal Entry</h3>
        <form id="quickAddForm">
            {% csrf_token %}
            <div class="form-group">
                <input 
                    type="text" 
                    id="quick-title" 
                    name="title" 
                    placeholder="Entry Title" 
                    required
                    data-testid="quick-add-title"
                >
            </div>
            <div class="form-group">
                <textarea 
                    id="quick-body" 
                    name="body" 
                    placeholder="Write something..." 
                    rows="6" 
                    required
                    data-testid="quick-add-body"
                ></textarea>
            </div>
            <div class="error-message" id="quick-error" hidden></div>
            <div class="modal-actions">
                <button type="submit" class="btn-primary" data-testid="quick-add-submit">
                    <span class="btn-text">Save</span>
                    <span class="btn-loading" hidden>Saving...</span>
                </button>
                <button type="button" id="quickAddCancel" class="btn-secondary" data-testid="quick-add-cancel">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const createJournalBtn = document.getElementById('create-journal-btn');
    
    {% if show_quick_add_fab %}
    const quickAddBtn = document.getElementById('quick-add-btn');
    const quickAddModal = document.getElementById('quickAddModal');
    const quickAddForm = document.getElementById('quickAddForm');
    const quickAddCancel = document.getElementById('quickAddCancel');
    const errorDiv = document.getElementById('quick-error');
    
    // Defensive check - ensure all elements exist
    if (!quickAddBtn || !quickAddModal || !quickAddForm || !quickAddCancel || !errorDiv) {
        console.error('Quick add modal elements not found');
        return;
    }
    
    // CRITICAL: Force modal to be hidden on page load
    quickAddModal.setAttribute('hidden', '');
    
    // Define closeModal function in accessible scope
    function closeModal() {
        quickAddModal.setAttribute('hidden', '');
        quickAddForm.reset();
        errorDiv.setAttribute('hidden', '');
        errorDiv.textContent = '';
        console.log('Modal closed');
    }
    
    // Open quick add modal
    quickAddBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        quickAddModal.removeAttribute('hidden');
        document.getElementById('quick-title').focus();
        console.log('Modal opened');
    });
    
    // Close on cancel button click
    quickAddCancel.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        closeModal();
    });
    
    // Close on overlay click (click outside modal content)
    const modalOverlay = quickAddModal.querySelector('.modal-overlay');
    if (modalOverlay) {
        modalOverlay.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            closeModal();
        });
    }
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !quickAddModal.hasAttribute('hidden')) {
            closeModal();
        }
    });
    
    // Prevent clicks inside modal content from closing modal
    const modalContent = quickAddModal.querySelector('.modal-content');
    if (modalContent) {
        modalContent.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    }
    
    // Handle form submission
    quickAddForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const title = document.getElementById('quick-title').value;
        const body = document.getElementById('quick-body').value;
        
        if (!title.trim() || !body.trim()) {
            errorDiv.textContent = 'Both title and body are required.';
            errorDiv.removeAttribute('hidden');
            return;
        }
        
        const submitBtn = quickAddForm.querySelector('[type="submit"]');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnLoading = submitBtn.querySelector('.btn-loading');
        
        // Clear previous errors
        errorDiv.setAttribute('hidden', '');
        errorDiv.textContent = '';
        
        // Disable button and show loading
        submitBtn.disabled = true;
        btnText.setAttribute('hidden', '');
        btnLoading.removeAttribute('hidden');
        
        try {
            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfInput) {
                console.error('CSRF token not found');
                errorDiv.textContent = 'Security token missing. Please refresh the page.';
                errorDiv.removeAttribute('hidden');
                submitBtn.disabled = false;
                btnText.removeAttribute('hidden');
                btnLoading.setAttribute('hidden', '');
                return;
            }
            const csrfToken = csrfInput.value;
            const response = await fetch('/home/api/journals/quick-add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ title: title.trim(), body: body.trim() })
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                // Redirect to My Journals with highlight
                window.location.href = `/home/my-journals/?highlight=${data.entry.id}`;
            } else {
                // Show error
                const errorMsg = data.errors?.title || data.errors?.body || 'Failed to create entry. Please try again.';
                errorDiv.textContent = errorMsg;
                errorDiv.removeAttribute('hidden');
                
                // Re-enable button
                submitBtn.disabled = false;
                btnText.removeAttribute('hidden');
                btnLoading.setAttribute('hidden', '');
            }
        } catch (error) {
            console.error('Error creating quick entry:', error);
            errorDiv.textContent = 'Network error. Please check your connection and try again.';
            errorDiv.removeAttribute('hidden');
            
            // Re-enable button
            submitBtn.disabled = false;
            btnText.removeAttribute('hidden');
            btnLoading.setAttribute('hidden', '');
        }
    });
    {% endif %}
    
    // Enable Quick Add feature link
    const enableLink = document.getElementById('enable-quick-add');
    if (enableLink) {
        enableLink.addEventListener('click', async function(e) {
            e.preventDefault();
            
            const originalText = enableLink.textContent;
            enableLink.textContent = 'Enabling...';
            enableLink.style.pointerEvents = 'none';
            
            try {
                const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
                if (!csrfInput) {
                    console.error('CSRF token not found');
                    alert('Security token missing. Please refresh the page.');
                    enableLink.textContent = originalText;
                    enableLink.style.pointerEvents = 'auto';
                    return;
                }
                const csrfToken = csrfInput.value;
                const response = await fetch('/home/api/preferences/quick-add/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ enabled: true })
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    const data = await response.json();
                    alert('Failed to enable Quick Add: ' + (data.error || 'Unknown error'));
                    enableLink.textContent = originalText;
                    enableLink.style.pointerEvents = 'auto';
                }
            } catch (error) {
                console.error('Error enabling Quick Add:', error);
                alert('Failed to enable Quick Add. Please try again.');
                enableLink.textContent = originalText;
                enableLink.style.pointerEvents = 'auto';
            }
        });
    }
    
    // Start timer for regular journal creation
    createJournalBtn.addEventListener('click', function() {
        const startTime = Date.now();
        sessionStorage.setItem('journalWritingStartTime', startTime.toString());
        console.log('Timer started at:', new Date(startTime));
    });
});
</script>
{% endblock %}